<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LMIC DFW Employment Access Index</title>

        <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
        <link
            href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css"
            rel="stylesheet"
        />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
            crossorigin="anonymous"
        />
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
            crossorigin="anonymous"
        ></script>

        <style>
            body {
                margin: 0;
                padding: 0;
                font-family: sans-serif;
            }

            #banner {
                background-color: rgba(0, 51, 133, 1);
                z-index: 1000;
            }

            #dc_logo {
                height: 4rem;
            }

            .navbar-brand {
                margin-left: 1rem;
                margin-right: 1rem;
                margin-top: 1rem;
                margin-bottom: 1rem;
            }

            .navbar-toggler {
                border-width: 0.2rem;
                padding: 0.1rem;
                margin-right: 1rem;
            }

            .nav-link {
                font-size: 1rem;
                font-weight: bold;
                padding: 0.5rem 0.5rem 0.5rem 0.5rem;
                margin-left: 0.5rem;
                margin-right: 0.5rem;
            }

            #mainmap {
                position: absolute;
                top: 4rem;
                bottom: 0;
                width: 100%;
                height: auto;
                z-index: -1000;
            }

            #legend {
                position: absolute;
                top: 5rem;
                right: 1rem;
                width: auto;
                height: auto;
                max-height: 90%;
                padding-top: 0rem;
                padding-right: 1rem;
                padding-left: 1rem;
                padding-bottom: 0rem;
                color: rgba(0, 0, 0, 0.9);
                background-color: rgba(255, 255, 255, 0.9);
                font-size: 0.9rem;
                overflow: auto;
                box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
                border-radius: 4px;
            }

            .row {
                margin-top: 1rem;
            }

            #header {
                font-weight: bold;
            }

            .form-select {
                font-size: 0.9rem;
            }

            #colorbar {
                width: 15rem;
            }

            .btn {
                background-color: rgba(229, 38, 38, 0.9);
                border-style: none;
                margin-bottom: 1rem;
                width: 8rem;
            }

            .btn:hover {
                background-color: rgba(229, 38, 38, 1);
            }

            .btn:focus {
                background-color: rgba(229, 38, 38, 1);
            }

            .btn:active {
                background-color: rgba(229, 38, 38, 1);
            }
        </style>
    </head>

    <body>
        <nav
            class="navbar navbar-expand-lg navbar-dark g-0 p-0 m-0"
            id="banner"
        >
            <a
                class="navbar-brand p-0"
                href="https://www.dallascollege.edu/business-industry/lmic/pages/default.aspx"
            >
                <img
                    src="https://raw.githubusercontent.com/Dallas-College-LMIC/spatial-jobs-index/e8094a75034b8627e629a350e0f1a2a81a0f468a/DCLOGO_RGB_MASTER_MARK-V-WHITE.png"
                    id="dc_logo"
                />
            </a>
            <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#bannertoggle"
            >
                <span class="navbar-toggler-icon"></span>
            </button>
            <div
                class="collapse navbar-collapse p-0 justify-content-start"
                id="bannertoggle"
            >
                <ul class="navbar-nav p-0">
                    <a class="nav-link" href="index.html"> Project Home </a>
                    <a class="nav-link active" href="access_wagelvl.html">
                        Job Access by Wage Level
                    </a>
                    <a class="nav-link">
                        Job Access by Occupation (in progress)
                    </a>
                    <a class="nav-link">
                        Job Access by School of (in progress)
                    </a>
                    <a class="nav-link"> Travelsheds by Tract (in progress) </a>
                </ul>
            </div>
        </nav>

        <div class="container-fluid p-0" id="mainmap"></div>
        <!-- placeholder for main map -->

        <div id="legend">
            <div class="container g-0">
                <div class="row g-0 justify-content-start">
                    <div class="col-auto" id="header">
                        Transit Travelshed Index
                    </div>
                </div>
                <div class="row g-0 justify-content-center">
                    <div class="col-12">
                        <select class="form-select" id="tti">
                            <option value="pop">Access to Jobs</option>
                            <option value="job">
                                Access to Living Wage Jobs
                            </option>
                            <option value="lab">
                                Access to Not Living Wage Jobs
                            </option>
                        </select>
                    </div>
                </div>
                <div class="row g-0 justify-content-center">
                    <hr />
                    <div class="col-12">
                        <img src="colorbar.png" id="colorbar" />
                    </div>
                </div>
                <div class="row g-0 justify-content-center">
                    <hr />
                    <div class="col-auto">
                        <a
                            class="btn btn-primary btn-sm"
                            id="exp"
                            href="https://raw.githubusercontent.com/Dallas-College-LMIC/spatial-jobs-index/refs/heads/master/mapbox/tti_clone.geojson"
                            target="blank"
                        >
                            Export
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <script>
            "use strict";
            mapboxgl.accessToken =
                "pk.eyJ1IjoiY2dpbGNocmllc3QtZGNjY2QiLCJhIjoiY200aXNueG5hMDV6czJtcTBweTFlZG9weSJ9.BV1l4NoP08wC2vlkhYR2Pg";

            var map = new mapboxgl.Map({
                container: "mainmap",
                style: "mapbox://styles/mapbox/light-v10",
                hash: true,
                attributionControl: true,
                customAttribution:
                    '<b><a href="https://github.com/NYCPlanning/td-travelshed/blob/master/Transit%20Travelshed.pdf" target="_blank">Detailed Methodology</a></b>',
                preserveDrawingBuffer: true,
                center: [-97.0336, 32.8999],
                zoom: 10.8,
            });

            map.on("style.load", function () {
                // Add controls first
                map.addControl(
                    new mapboxgl.FullscreenControl({
                        container: document.querySelector("body"),
                    }),
                    "bottom-left",
                );
                map.addControl(
                    new mapboxgl.NavigationControl({
                        showCompass: true,
                        showZoom: true,
                        visualizePitch: true,
                    }),
                    "bottom-left",
                );

                fetch("https://sji-api.dimensiondoor.xyz/geojson", {
                    headers: {
                        Authorization:
                            "Basic " +
                            btoa(
                                "dclmic:<IG0Qam*D927G>mZcf@J*Y!R+F:U;N?m*@284V1%Q2:+6s",
                            ),
                    },
                })
                    .then((res) => {
                        console.log("Response status:", res.status);
                        console.log("Response headers:", res.headers);

                        if (!res.ok) {
                            throw new Error(
                                `HTTP error! status: ${res.status}`,
                            );
                        }
                        return res.json();
                    })
                    .then((geojsonData) => {
                        console.log("Fetched data:", geojsonData);
                        console.log(
                            "Number of features:",
                            geojsonData.features?.length,
                        );

                        if (
                            geojsonData.features &&
                            geojsonData.features.length > 0
                        ) {
                            console.log(
                                "First feature properties:",
                                geojsonData.features[0].properties,
                            );
                            console.log(
                                "Available property names:",
                                Object.keys(geojsonData.features[0].properties),
                            );
                        }

                        // Add source with fetched data
                        map.addSource("tti_data", {
                            type: "geojson",
                            data: geojsonData,
                        });

                        // Add layers after data is loaded
                        addLayers();
                        addPopupEvents();
                        setupDropdownListener();
                    })
                    .catch((error) => {
                        console.error("Detailed error:", error);
                        console.error("Error message:", error.message);
                        console.error("Error stack:", error.stack);
                    });

                function addLayers() {
                    // Function to create layer configuration
                    function createLayerConfig(layerid, visibility, colname) {
                        return {
                            sourceid: "tti_data",
                            layerid: layerid,
                            layertype: "fill",
                            layervisibility: visibility,
                            layercolname: colname,
                            layercat: [
                                "<-2.5SD",
                                "-2.5SD ~ -1.5SD",
                                "-1.5SD ~ -0.5SD",
                                "-0.5SD ~ +0.5SD",
                                "+0.5SD ~ +1.5SD",
                                "+1.5SD ~ +2.5SD",
                                ">=+2.5SD",
                            ],
                            layercolor: [
                                "rgba(43, 131, 186, 0.8)",
                                "rgba(128, 191, 172, 0.8)",
                                "rgba(199, 233, 173, 0.8)",
                                "rgba(255, 255, 191, 0.8)",
                                "rgba(254, 201, 128, 0.8)",
                                "rgba(241, 124, 74, 0.8)",
                                "rgba(215, 25, 28, 0.8)",
                            ],
                            layeroutlinecolor: "rgba(0, 0, 0, 0.1)",
                        };
                    }

                    // Create and add layers
                    const layers = [
                        createLayerConfig(
                            "pop",
                            "visible",
                            "all_jobs_zscore_cat",
                        ),
                        createLayerConfig(
                            "job",
                            "none",
                            "living_wage_zscore_cat",
                        ),
                        createLayerConfig(
                            "lab",
                            "none",
                            "not_living_wage_zscore_cat",
                        ),
                    ];

                    layers.forEach((layerContent) => {
                        const layerColor = [
                            "match",
                            ["get", layerContent.layercolname],
                        ];
                        layerContent.layercat.forEach((cat, i) => {
                            layerColor.push(cat, layerContent.layercolor[i]);
                        });
                        layerColor.push("#000000");

                        map.addLayer({
                            id: layerContent.layerid,
                            type: layerContent.layertype,
                            source: layerContent.sourceid,
                            layout: {
                                visibility: layerContent.layervisibility,
                            },
                            paint: {
                                "fill-color": layerColor,
                                "fill-outline-color":
                                    layerContent.layeroutlinecolor,
                            },
                        });
                    });
                }

                function addPopupEvents() {
                    const popup = new mapboxgl.Popup({
                        closeButton: true,
                        closeOnClick: false,
                        anchor: "bottom",
                        offset: 0,
                        maxWidth: "none",
                    });

                    function setupPopup(layer, title, property) {
                        map.on("click", layer, (e) => {
                            const coordinates = e.lngLat;
                            const description = `<b>Tract: </b><span>${e.features[0].properties.GEOID}</span><br>
                                         <b>${title}: </b><span>${e.features[0].properties[property].toFixed(2)}</span>`;
                            popup
                                .setLngLat(coordinates)
                                .setHTML(description)
                                .addTo(map);
                        });

                        map.on(
                            "mouseenter",
                            layer,
                            () => (map.getCanvas().style.cursor = "pointer"),
                        );
                        map.on(
                            "mouseleave",
                            layer,
                            () => (map.getCanvas().style.cursor = ""),
                        );
                    }

                    setupPopup("pop", "Access to All Jobs", "all_jobs_zscore");
                    setupPopup(
                        "job",
                        "Access to Living Wage Jobs",
                        "living_wage_zscore",
                    );
                    setupPopup(
                        "lab",
                        "Access to Not Living Wage Jobs",
                        "Not_Living_Wage_zscore",
                    );
                }

                function setupDropdownListener() {
                    const tti = document.getElementById("tti");
                    const layerOrder = ["pop", "job", "lab"];

                    tti.addEventListener("change", function () {
                        const chosenLayer = this.value;
                        layerOrder.forEach((layer) => {
                            map.setLayoutProperty(
                                layer,
                                "visibility",
                                layer === chosenLayer ? "visible" : "none",
                            );
                        });
                        document.getElementById("exp").href =
                            "https://sji-api.dimensiondoor.xyz/geojson";
                    });
                }
            });
        </script>
    </body>
</html>
