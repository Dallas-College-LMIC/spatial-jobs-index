<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC DCP Transit Travelshed</title>

    <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
        crossorigin="anonymous"></script>



    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }

        #mainmap {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: auto;
        }

        #legend {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: auto;
            height: auto;
            max-height: 90%;
            padding-top: 0rem;
            padding-right: 1rem;
            padding-left: 1rem;
            padding-bottom: 1rem;
            color: rgba(0, 0, 0, 0.9);
            background-color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            overflow: auto;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        .row {
            margin-top: 1rem;
        }

        .header {
            font-weight: bold;
        }

        .form-select {
            font-size: 0.9rem;
        }

        .key-circle {
            width: 0.3rem;
            height: 0.3rem;
            margin-right: 0.5rem;
            border-radius: 100%;
            display: inline-block;
            vertical-align: 0.2rem;
        }

        #colorbar {
            width: 25rem;
        }
    </style>
</head>



<body>
    <div class="container-fluid p-0" id="mainmap"> </div> <!-- placeholder for main map -->

    <div id="legend">
        <div class="container g-0">
            <div class="row g-0 justify-content-start">
                <div class="col-auto header"> Residence Place by Race </div>
            </div>
            <div class="row g-0 justify-content-center">
                <div class="col-12">
                    <select class='form-select' id='race'>
                        <option value='white'> White Alone </option>
                        <option value='black'> Black or African American Alone </option>
                        <option value='native'> American Indian and Alaska Native Alone </option>
                        <option value='asian'> Asian Alone </option>
                        <option value='pacific'> Native Hawaiian and Other Pacific Islander Alone </option>
                        <option value='other1'> Some Other Race Alone </option>
                        <option value='other2'> Two or More Races </option>
                    </select>
                </div>
            </div>
            <div class="row g-0 justify-content-center">
                <div class="col-12">
                    <span class="key-circle" style="background-color: rgba(0, 0, 0, 0.8);"></span>
                    <label> 1 dot represents 100 people </label>
                </div>
            </div>
            <hr>
            <div class="row g-0 justify-content-start">
                <div class="col-auto header"> Transit Access to Jobs Index </div>
            </div>
            <div class="row g-0 justify-content-center">
                <div class="col-auto">
                    <img src="https://raw.githubusercontent.com/NYCPlanning/td-travelshed/master/postotp/race/colorbar2.png"
                        id="colorbar">
                </div>
            </div>
        </div>
    </div>



    <script>
        'use strict';
        // Set MapBox token
        mapboxgl.accessToken = 'pk.eyJ1IjoibWF5aWp1biIsImEiOiJjaXg4ZmlyY20wMDBjMm9tcjI0bjQ0Z21zIn0.Io0XJ4JelN903V9HGo4TfQ'; // still need to find a way to store the token



        // Initialize the map
        var map = new mapboxgl.Map({ // creating a new map
            container: 'mainmap', // same as the div id to place the map
            style: 'mapbox://styles/mapbox/light-v10', // light base map
            hash: true, // make sure it's on to get the url with map view
            attributionControl: true, // show the credit bar
            customAttribution: '<span>Click </span><a href="https://github.com/NYCPlanning/td-travelshed/blob/master/Transit%20Travelshed.pdf" target="_blank"><b>HERE</b></a><span> for detailed methodology</span>', // add overall credit to the beggining
            preserveDrawingBuffer: true, // make sure it's on to allow printing
            center: [-73.9469, 40.7121], // testing to get the centroid of bounds
            zoom: 9.5, // set the initial zoom of the map view
        });



        // Add layers
        map.on('load', function () {

            var layerContentList = []; // store all the layer contents

            // Add full screen control
            map.addControl(new mapboxgl.FullscreenControl({
                container: document.querySelector('body'),
            }),
                'bottom-left', // control position
            );

            // Add navigation control
            map.addControl(new mapboxgl.NavigationControl({
                showCompass: true, // show compass
                showZoom: true, // show zoom
                visualizePitch: true, // show pitch
            }),
                'bottom-left', // control position
            );


            // Add access to jobs
            // Set layer contents
            var layerContent = {
                'sourceid': 'job', // source id
                'sourcetype': 'geojson', // source type
                'sourcedata': 'https://raw.githubusercontent.com/NYCPlanning/td-travelshed/master/postotp/race/race.geojson', // data source
                'layerid': 'job', // layer id
                'layertype': 'fill', // symbology type
                'layername': 'Access to Jobs', // layer name for the legend
                'layervisibility': 'visible', // visibility of the layer
                'layercolname': 'JOBCAT', // category column name
                'layercat': ['<-0.5SD', '-0.5SD ~ 0SD', '0SD ~ +0.5SD', '+0.5SD ~ +1SD', '+1SD ~ +1.5SD', '+1.5SD ~ +2SD', '>=+2SD'], // categories
                'layercolor': ['rgba(43, 131, 186, 0.8)', 'rgba(128, 191, 172, 0.8)', 'rgba(199, 233, 173, 0.8)', 'rgba(255, 255, 191, 0.8)', 'rgba(254, 201, 128, 0.8)', 'rgba(241, 124, 74, 0.8)', 'rgba(215, 25, 28, 0.8)'], // fill color; use rgba
                'layeroutlinecolor': 'rgba(255, 255, 255, 0)', // outline color; can only be set to 1px width; to change the outline width, add another line layer
            };

            // Generate layer colors
            var layerColor = ['match', ['get', layerContent['layercolname']]];
            for (var i = 0; i < layerContent.layercat.length; i++) {
                layerColor.push(layerContent.layercat[i]);
                layerColor.push(layerContent.layercolor[i]);
            };
            layerColor.push('#000000');

            // Add layer content to the overall layer content list
            layerContentList.push(layerContent);

            // Add data source
            map.addSource(layerContent['sourceid'], {
                'type': layerContent['sourcetype'],
                'data': layerContent['sourcedata'],
            });

            // Add fill layer
            map.addLayer({
                'id': layerContent['layerid'],
                'type': layerContent['layertype'],
                'source': layerContent['sourceid'],
                'layout': {
                    'visibility': layerContent['layervisibility'],
                },
                'paint': {
                    'fill-color': layerColor,
                    // 'fill-outline-color': layerContent['layeroutlinecolor'],
                },
            });



            // Add white
            // Set layer contents
            var layerContent = {
                'sourceid': 'white', // source id
                'sourcetype': 'geojson', // source type
                'sourcedata': 'https://raw.githubusercontent.com/NYCPlanning/td-travelshed/master/postotp/race/white.geojson', // data source
                'layerid': 'white', // layer id
                'layertype': 'circle', // symbology type
                'layername': 'white', // layer name for the legend
                'layervisibility': 'visible', // visibility of the layer
                'layerblur': 0, // blur circle
                'layercolname': '', // category column name
                'layercat': [''], // categories
                'layercolor': ['rgba(0, 0, 0, 0.2)'], // color for each category; use rgba
                'layeropacity': 1, // circle opacity
                'layerradius': 1.5, // circle radius; change size based on zoom level
                'layerstrokecolor': 'rgba(255, 255, 255, 0)', // circle stroke color
                'layerstrokeopacity': 0, // circle stroke opacity
                'layerstrokewidth': 0.5, // circle stroke width
                'layeroutlinecolor': 'rgba(255, 255, 255, 0)',  // outline color; for legend purpose only
            };

            // Add layer content to the overall layer content list
            layerContentList.push(layerContent);

            // Add data source
            map.addSource(layerContent['sourceid'], {
                'type': layerContent['sourcetype'],
                'data': layerContent['sourcedata'],
            });

            // Add circle layer
            map.addLayer({
                'id': layerContent['layerid'],
                'type': layerContent['layertype'],
                'source': layerContent['sourceid'],
                'layout': {
                    'visibility': layerContent['layervisibility'],
                },
                'paint': {
                    'circle-blur': layerContent['layerblur'],
                    'circle-color': layerContent['layercolor'][0],
                    'circle-opacity': layerContent['layeropacity'],
                    'circle-radius': layerContent['layerradius'],
                    'circle-stroke-color': layerContent['layerstrokecolor'],
                    'circle-stroke-opacity': layerContent['layerstrokeopacity'],
                    'circle-stroke-width': layerContent['layerstrokewidth'],
                },
            });



            // Add black
            // Set layer contents
            var layerContent = {
                'sourceid': 'black', // source id
                'sourcetype': 'geojson', // source type
                'sourcedata': 'https://raw.githubusercontent.com/NYCPlanning/td-travelshed/master/postotp/race/black.geojson', // data source
                'layerid': 'black', // layer id
                'layertype': 'circle', // symbology type
                'layername': 'black', // layer name for the legend
                'layervisibility': 'none', // visibility of the layer
                'layerblur': 0, // blur circle
                'layercolname': '', // category column name
                'layercat': [''], // categories
                'layercolor': ['rgba(0, 0, 0, 0.2)'], // color for each category; use rgba
                'layeropacity': 1, // circle opacity
                'layerradius': 1.5, // circle radius; change size based on zoom level
                'layerstrokecolor': 'rgba(255, 255, 255, 0)', // circle stroke color
                'layerstrokeopacity': 0, // circle stroke opacity
                'layerstrokewidth': 0.5, // circle stroke width
                'layeroutlinecolor': 'rgba(255, 255, 255, 0)',  // outline color; for legend purpose only
            };

            // Add layer content to the overall layer content list
            layerContentList.push(layerContent);

            // Add data source
            map.addSource(layerContent['sourceid'], {
                'type': layerContent['sourcetype'],
                'data': layerContent['sourcedata'],
            });

            // Add circle layer
            map.addLayer({
                'id': layerContent['layerid'],
                'type': layerContent['layertype'],
                'source': layerContent['sourceid'],
                'layout': {
                    'visibility': layerContent['layervisibility'],
                },
                'paint': {
                    'circle-blur': layerContent['layerblur'],
                    'circle-color': layerContent['layercolor'][0],
                    'circle-opacity': layerContent['layeropacity'],
                    'circle-radius': layerContent['layerradius'],
                    'circle-stroke-color': layerContent['layerstrokecolor'],
                    'circle-stroke-opacity': layerContent['layerstrokeopacity'],
                    'circle-stroke-width': layerContent['layerstrokewidth'],
                },
            });



            // Add native
            // Set layer contents
            var layerContent = {
                'sourceid': 'native', // source id
                'sourcetype': 'geojson', // source type
                'sourcedata': 'https://raw.githubusercontent.com/NYCPlanning/td-travelshed/master/postotp/race/native.geojson', // data source
                'layerid': 'native', // layer id
                'layertype': 'circle', // symbology type
                'layername': 'native', // layer name for the legend
                'layervisibility': 'none', // visibility of the layer
                'layerblur': 0, // blur circle
                'layercolname': '', // category column name
                'layercat': [''], // categories
                'layercolor': ['rgba(0, 0, 0, 0.2)'], // color for each category; use rgba
                'layeropacity': 1, // circle opacity
                'layerradius': 1.5, // circle radius; change size based on zoom level
                'layerstrokecolor': 'rgba(255, 255, 255, 0)', // circle stroke color
                'layerstrokeopacity': 0, // circle stroke opacity
                'layerstrokewidth': 0.5, // circle stroke width
                'layeroutlinecolor': 'rgba(255, 255, 255, 0)',  // outline color; for legend purpose only
            };

            // Add layer content to the overall layer content list
            layerContentList.push(layerContent);

            // Add data source
            map.addSource(layerContent['sourceid'], {
                'type': layerContent['sourcetype'],
                'data': layerContent['sourcedata'],
            });

            // Add circle layer
            map.addLayer({
                'id': layerContent['layerid'],
                'type': layerContent['layertype'],
                'source': layerContent['sourceid'],
                'layout': {
                    'visibility': layerContent['layervisibility'],
                },
                'paint': {
                    'circle-blur': layerContent['layerblur'],
                    'circle-color': layerContent['layercolor'][0],
                    'circle-opacity': layerContent['layeropacity'],
                    'circle-radius': layerContent['layerradius'],
                    'circle-stroke-color': layerContent['layerstrokecolor'],
                    'circle-stroke-opacity': layerContent['layerstrokeopacity'],
                    'circle-stroke-width': layerContent['layerstrokewidth'],
                },
            });



            // Add asian
            // Set layer contents
            var layerContent = {
                'sourceid': 'asian', // source id
                'sourcetype': 'geojson', // source type
                'sourcedata': 'https://raw.githubusercontent.com/NYCPlanning/td-travelshed/master/postotp/race/asian.geojson', // data source
                'layerid': 'asian', // layer id
                'layertype': 'circle', // symbology type
                'layername': 'asian', // layer name for the legend
                'layervisibility': 'none', // visibility of the layer
                'layerblur': 0, // blur circle
                'layercolname': '', // category column name
                'layercat': [''], // categories
                'layercolor': ['rgba(0, 0, 0, 0.2)'], // color for each category; use rgba
                'layeropacity': 1, // circle opacity
                'layerradius': 1.5, // circle radius; change size based on zoom level
                'layerstrokecolor': 'rgba(255, 255, 255, 0)', // circle stroke color
                'layerstrokeopacity': 0, // circle stroke opacity
                'layerstrokewidth': 0.5, // circle stroke width
                'layeroutlinecolor': 'rgba(255, 255, 255, 0)',  // outline color; for legend purpose only
            };

            // Add layer content to the overall layer content list
            layerContentList.push(layerContent);

            // Add data source
            map.addSource(layerContent['sourceid'], {
                'type': layerContent['sourcetype'],
                'data': layerContent['sourcedata'],
            });

            // Add circle layer
            map.addLayer({
                'id': layerContent['layerid'],
                'type': layerContent['layertype'],
                'source': layerContent['sourceid'],
                'layout': {
                    'visibility': layerContent['layervisibility'],
                },
                'paint': {
                    'circle-blur': layerContent['layerblur'],
                    'circle-color': layerContent['layercolor'][0],
                    'circle-opacity': layerContent['layeropacity'],
                    'circle-radius': layerContent['layerradius'],
                    'circle-stroke-color': layerContent['layerstrokecolor'],
                    'circle-stroke-opacity': layerContent['layerstrokeopacity'],
                    'circle-stroke-width': layerContent['layerstrokewidth'],
                },
            });



            // Add pacific
            // Set layer contents
            var layerContent = {
                'sourceid': 'pacific', // source id
                'sourcetype': 'geojson', // source type
                'sourcedata': 'https://raw.githubusercontent.com/NYCPlanning/td-travelshed/master/postotp/race/pacific.geojson', // data source
                'layerid': 'pacific', // layer id
                'layertype': 'circle', // symbology type
                'layername': 'pacific', // layer name for the legend
                'layervisibility': 'none', // visibility of the layer
                'layerblur': 0, // blur circle
                'layercolname': '', // category column name
                'layercat': [''], // categories
                'layercolor': ['rgba(0, 0, 0, 0.2)'], // color for each category; use rgba
                'layeropacity': 1, // circle opacity
                'layerradius': 1.5, // circle radius; change size based on zoom level
                'layerstrokecolor': 'rgba(255, 255, 255, 0)', // circle stroke color
                'layerstrokeopacity': 0, // circle stroke opacity
                'layerstrokewidth': 0.5, // circle stroke width
                'layeroutlinecolor': 'rgba(255, 255, 255, 0)',  // outline color; for legend purpose only
            };

            // Add layer content to the overall layer content list
            layerContentList.push(layerContent);

            // Add data source
            map.addSource(layerContent['sourceid'], {
                'type': layerContent['sourcetype'],
                'data': layerContent['sourcedata'],
            });

            // Add circle layer
            map.addLayer({
                'id': layerContent['layerid'],
                'type': layerContent['layertype'],
                'source': layerContent['sourceid'],
                'layout': {
                    'visibility': layerContent['layervisibility'],
                },
                'paint': {
                    'circle-blur': layerContent['layerblur'],
                    'circle-color': layerContent['layercolor'][0],
                    'circle-opacity': layerContent['layeropacity'],
                    'circle-radius': layerContent['layerradius'],
                    'circle-stroke-color': layerContent['layerstrokecolor'],
                    'circle-stroke-opacity': layerContent['layerstrokeopacity'],
                    'circle-stroke-width': layerContent['layerstrokewidth'],
                },
            });



            // Add other1
            // Set layer contents
            var layerContent = {
                'sourceid': 'other1', // source id
                'sourcetype': 'geojson', // source type
                'sourcedata': 'https://raw.githubusercontent.com/NYCPlanning/td-travelshed/master/postotp/race/other1.geojson', // data source
                'layerid': 'other1', // layer id
                'layertype': 'circle', // symbology type
                'layername': 'other1', // layer name for the legend
                'layervisibility': 'none', // visibility of the layer
                'layerblur': 0, // blur circle
                'layercolname': '', // category column name
                'layercat': [''], // categories
                'layercolor': ['rgba(0, 0, 0, 0.2)'], // color for each category; use rgba
                'layeropacity': 1, // circle opacity
                'layerradius': 1.5, // circle radius; change size based on zoom level
                'layerstrokecolor': 'rgba(255, 255, 255, 0)', // circle stroke color
                'layerstrokeopacity': 0, // circle stroke opacity
                'layerstrokewidth': 0.5, // circle stroke width
                'layeroutlinecolor': 'rgba(255, 255, 255, 0)',  // outline color; for legend purpose only
            };

            // Add layer content to the overall layer content list
            layerContentList.push(layerContent);

            // Add data source
            map.addSource(layerContent['sourceid'], {
                'type': layerContent['sourcetype'],
                'data': layerContent['sourcedata'],
            });

            // Add circle layer
            map.addLayer({
                'id': layerContent['layerid'],
                'type': layerContent['layertype'],
                'source': layerContent['sourceid'],
                'layout': {
                    'visibility': layerContent['layervisibility'],
                },
                'paint': {
                    'circle-blur': layerContent['layerblur'],
                    'circle-color': layerContent['layercolor'][0],
                    'circle-opacity': layerContent['layeropacity'],
                    'circle-radius': layerContent['layerradius'],
                    'circle-stroke-color': layerContent['layerstrokecolor'],
                    'circle-stroke-opacity': layerContent['layerstrokeopacity'],
                    'circle-stroke-width': layerContent['layerstrokewidth'],
                },
            });



            // Add other2
            // Set layer contents
            var layerContent = {
                'sourceid': 'other2', // source id
                'sourcetype': 'geojson', // source type
                'sourcedata': 'https://raw.githubusercontent.com/NYCPlanning/td-travelshed/master/postotp/race/other2.geojson', // data source
                'layerid': 'other2', // layer id
                'layertype': 'circle', // symbology type
                'layername': 'other2', // layer name for the legend
                'layervisibility': 'none', // visibility of the layer
                'layerblur': 0, // blur circle
                'layercolname': '', // category column name
                'layercat': [''], // categories
                'layercolor': ['rgba(0, 0, 0, 0.2)'], // color for each category; use rgba
                'layeropacity': 1, // circle opacity
                'layerradius': 1.5, // circle radius; change size based on zoom level
                'layerstrokecolor': 'rgba(255, 255, 255, 0)', // circle stroke color
                'layerstrokeopacity': 0, // circle stroke opacity
                'layerstrokewidth': 0.5, // circle stroke width
                'layeroutlinecolor': 'rgba(255, 255, 255, 0)',  // outline color; for legend purpose only
            };

            // Add layer content to the overall layer content list
            layerContentList.push(layerContent);

            // Add data source
            map.addSource(layerContent['sourceid'], {
                'type': layerContent['sourcetype'],
                'data': layerContent['sourcedata'],
            });

            // Add circle layer
            map.addLayer({
                'id': layerContent['layerid'],
                'type': layerContent['layertype'],
                'source': layerContent['sourceid'],
                'layout': {
                    'visibility': layerContent['layervisibility'],
                },
                'paint': {
                    'circle-blur': layerContent['layerblur'],
                    'circle-color': layerContent['layercolor'][0],
                    'circle-opacity': layerContent['layeropacity'],
                    'circle-radius': layerContent['layerradius'],
                    'circle-stroke-color': layerContent['layerstrokecolor'],
                    'circle-stroke-opacity': layerContent['layerstrokeopacity'],
                    'circle-stroke-width': layerContent['layerstrokewidth'],
                },
            });





            // Add popup
            var popup = new mapboxgl.Popup({
                closeButton: true, // close button
                closeOnClick: false, // close if click on map
                closeOnMove: false, // close if move the map
                anchor: 'bottom', // anchor of the popup
                offset: 0, // offset from the feature
                maxWidth: 'none', // max width of the popoup; 'none' to fit to the content              
            });

            // Add access to jobs popup
            // Add hover event
            map.on('click', 'job', function (e) {
                map.getCanvas().style.cursor = 'pointer'; // mouse becoming pointer
                var coordinates = e.lngLat; // get pointer coordinates
                var description = "<b>Cesnsu Tract: </b><span>" + e.features[0].properties.tractid + "</span><br>"; // description in the popup
                description += "<b>Total Population: </b><span>" + e.features[0].properties.TOTAL.toLocaleString() + "</span><br>";
                description += "<b>White Alone: </b><span>" + e.features[0].properties.WHITE.toLocaleString() + "</span><br>";
                description += "<b>Black or African American Alone: </b><span>" + e.features[0].properties.BLACK.toLocaleString() + "</span><br>";
                description += "<b>American Indian and Alaska Native Alone: </b><span>" + e.features[0].properties.NATIVE.toLocaleString() + "</span><br>";
                description += "<b>Asian Alone: </b><span>" + e.features[0].properties.ASIAN.toLocaleString() + "</span><br>";
                description += "<b>Native Hawaiian and Other Pacific Islander Alone: </b><span>" + e.features[0].properties.PACIFIC.toLocaleString() + "</span><br>";
                description += "<b>Some Other Race Alone: </b><span>" + e.features[0].properties.OTHER1.toLocaleString() + "</span><br>";
                description += "<b>Two or More Races : </b><span>" + e.features[0].properties.OTHER2.toLocaleString() + "</span><br>";
                description += "<b>Transit Access to Jobs Index: </b><span>" + e.features[0].properties.GRAVITYWAC.toFixed(2) + "</span><br>";
                description += "<b>Standard Deviation from Average: </b><span>" + e.features[0].properties.JOBSTD.toFixed(2) + "</span><br>";
                description += "<b>Percentile: </b><span>" + e.features[0].properties.JOBPCT + "%</span><br>";
                popup.setLngLat(coordinates).setHTML(description).addTo(map); //add popup
            });
            // Add hover events
            map.on('mouseenter', 'job', function () {
                map.getCanvas().style.cursor = 'pointer'; // mouse becoming pointer
            });
            map.on('mouseleave', 'job', function () {
                map.getCanvas().style.cursor = '';
            });


            // Create click event
            var layerOrder = ['white', 'black', 'native', 'asian', 'pacific', 'other1', 'other2']; // set layer order in the legend
            race.addEventListener('change', function () {
                var chosenLayer = document.getElementById('race').value;
                map.setLayoutProperty(chosenLayer, 'visibility', 'visible'); // set layer visibility
                var unchosenLayer = layerOrder.filter(function (x) { return x !== chosenLayer; });
                for (var i = 0; i < unchosenLayer.length; i++) {
                    map.setLayoutProperty(unchosenLayer[i], 'visibility', 'none'); // set layer visibility
                };
            });
        });
    </script>

</body>

</html>